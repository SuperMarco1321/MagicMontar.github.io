<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montador Magic Rampage - By Marco</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Estilos originais mantidos, com adição: */
        .loading { color: #ffcc00; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Montador de Personagens Magic Rampage</h1>
    <p>Criado por Marco para a comunidade! Clique nas imagens para selecionar.</p>

    <label>Cor do corpo: <input type="color" id="bodyColor" value="#ffffff"></label>
    <label>Cor dos olhos: <input type="color" id="eyeColor" value="#ffffff"></label>

    <h2>Corpo (obrigatório)</h2>
    <div class="catalog" id="bodyCatalog"></div>

    <h2>Armadura</h2>
    <button id="helmetToggle">Com Elmo</button>
    <div class="catalog" id="armorCatalog"></div>

    <h2>Amuleto</h2>
    <div class="catalog" id="amuletoCatalog"></div>

    <h2>Pet</h2>
    <div class="catalog" id="petCatalog"></div>

    <h2>Cabeça</h2>
    <div class="catalog" id="headCatalog"></div>

    <h2>Olhos (com brilho additive)</h2>
    <div class="catalog" id="eyeCatalog"></div>

    <h2>Arma</h2>
    <div class="catalog" id="weaponCatalog"></div>

    <button onclick="updatePreview()">Atualizar Preview</button>
    <button onclick="downloadPreview()">Baixar Preview Único</button>
    <button onclick="generateAll()">Gerar ZIP Completo</button>

    <canvas id="preview" width="400" height="400"></canvas>
    <p id="status">Carregando catálogo...</p>

    <script>
        const basePath = '';
        const folders = {
            body: 'Corpo',
            armor: 'Armaduras',
            amuleto: 'Amuleto',
            pet: 'Pet',
            head: 'Cabeça',
            eye: 'Olho',
            weapon: 'Arma'
        };

        let catalog = {};
        let selected = {};
        let data = {};
        let bodyColor = {r: 255, g: 255, b: 255};
        let eyeColor = {r: 255, g: 255, b: 255};
        let withHelmet = true;
        let folderPreviews = {}; // cache

        const helmetToggle = document.getElementById('helmetToggle');
        helmetToggle.onclick = () => {
            if (helmetToggle.classList.contains('disabled')) return;
            withHelmet = !withHelmet;
            helmetToggle.textContent = withHelmet ? 'Com Elmo' : 'Sem Elmo';
            if (selected.armor) loadArmor(selected.armor.name, selected.armor.type).catch(err => console.error(err));
        };

        function sanitizeName(name) {
            return name.replace(/[;+]/g, encodeURIComponent); // Sanitize nomes especiais
        }

        function createCatalog(catId, list, folder, isWeapon = false) {
            const cat = document.getElementById(catId);
            cat.innerHTML = '';
            list.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'item';
                div.setAttribute('aria-label', entry.display || entry.name); // Acessibilidade
                div.onclick = () => {
                    document.querySelectorAll(`#${catId} .selected`).forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    if (catId === 'armorCatalog') {
                        selected.armor = entry;
                        loadArmor(entry.name, entry.type).catch(err => console.error(err));
                    } else {
                        selected[catId.replace('Catalog', '')] = entry.name;
                        loadAsset(catId.replace('Catalog', ''), entry.name, folder, isWeapon).catch(err => console.error(err));
                    }
                };
                const img = document.createElement('img');
                if (catId === 'armorCatalog' && entry.type === 'folder') {
                    img.src = folderPreviews[entry.name] || 'https://placehold.it/100x100?text=Carregando...';
                    if (!folderPreviews[entry.name]) loadFolderPreview(entry.name, img).catch(() => {});
                } else {
                    img.src = basePath + `${folder}/Png/${sanitizeName(entry.name)}.png`;
                }
                img.onerror = () => img.src = 'https://placehold.it/100x100?text=Erro';
                div.appendChild(img);
                const span = document.createElement('span');
                span.innerText = (entry.display || entry.name).replace(/_/g, ' ');
                div.appendChild(span);
                cat.appendChild(div);
            });
        }

        async function loadFolderPreview(folderName, imgElement) {
            const repo = 'SuperMarco1321/MagicMontar.github.io';
            const apiUrl = `https://api.github.com/repos/${repo}/contents/${folders.armor}/Png/${sanitizeName(folderName)}`;
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error('API error');
                const files = await res.json();
                const pngFiles = files.filter(f => f.name.toLowerCase().endsWith('.png')).map(f => f.name).sort((a,b) => a.localeCompare(b));
                if (pngFiles.length > 0) {
                    const firstPng = pngFiles[0];
                    const previewUrl = basePath + `${folders.armor}/Png/${sanitizeName(folderName)}/${firstPng}`;
                    folderPreviews[folderName] = previewUrl;
                    imgElement.src = previewUrl;
                }
            } catch (e) {
                imgElement.src = 'https://placehold.it/100x100?text=Sem+Preview';
            }
        }

        // Funções loadArmor, loadAsset, parseXML, tintImage, calcularPosicao, montarFrame, cropImage, rotateImage, hexToRgb mantidas, com async/await onde possível.

        async function updatePreview() {
            bodyColor = hexToRgb(document.getElementById('bodyColor').value);
            eyeColor = hexToRgb(document.getElementById('eyeColor').value);
            const canvas = montarFrame(0);
            if (canvas) {
                const prev = document.getElementById('preview');
                prev.width = canvas.width;
                prev.height = canvas.height;
                prev.getContext("2d").drawImage(canvas, 0, 0);
                document.getElementById('status').innerText = 'Preview atualizado!';
            } else {
                document.getElementById('status').innerText = 'Selecione um corpo primeiro.';
            }
        }

        async function downloadPreview() {
            const canvas = montarFrame(0);
            if (canvas) {
                canvas.toBlob(blob => saveAs(blob, 'preview_personagem.png'));
            } else {
                alert('Selecione itens primeiro.');
            }
        }

        // generateAll e loadCatalog mantidos, com try/catch extras.

        window.onload = async () => {
            try {
                await loadCatalog();
            } catch (e) {
                document.getElementById('status').innerText = 'Erro ao carregar catálogo: ' + e.message;
            }
        };
    </script>
</body>
</html>
